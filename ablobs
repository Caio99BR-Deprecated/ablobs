#!/bin/bash
# Slim script to tracer blobs for Android ROMs by Caio99BR <caiooliveirafarias0@gmail.com>

# Empty variables
foundc=0
nfoundc=0
_lib_dir="lib/"
_vendor_lib_dir="vendor/lib/"
_lib_list="/tmp/ablobs"
_missing="$(pwd)/ablobs_missing-files.txt"

rm -rf ${_lib_list} ${_tmp_lib_list}

printf '\n  WARNING\n'
printf "Make sure you are inside of '/system' dir\n"
printf "If not, the script will be useless\n"
printf '  WARNING\n\n'
read -p "Press any key to continue..." -s ask
printf '\n\n'

# Make loop for usage of 'break' to recursive exit
while true
do
	if [ ! "${BASH_VERSION}" ]
	then
		echo "  |"
		echo "  | Please do not use 'sh' to run this script"
		echo "  | Just use 'source build.sh'"
		echo "  | Exiting from script!"
		break
	fi

	# Check for tools installed
	for TARGET in "objdump" "find" "grep" "sort" "uniq" "sed"
	do
		which ${TARGET} 1> /dev/null || { echo "  | ERROR: Install $TARGET before continuing."; break; }
	done

	echo "# Auto generated by Android Blob Utility Script" > ${_missing}

	printf 'objdump working, see to other side \n'
	objdump -x $(find . | grep -v /app | grep -v /priv-app | grep -v /usr | grep -v /tts | grep -v /etc | grep -v /media | grep -v /framework | grep -v /fonts | grep -v /addon.d | grep -v .txt | grep -v .bc | grep -v build.prop | grep -v keymaster | grep -v ablobs) | grep NEEDED | sort | uniq | cut -d " " -f 18 >> ${_lib_list}

	while IFS= read -r _file
	do
		if [[ -e ${_lib_dir}/${_file} ]]
		then
			foundc=$((foundc + 1))
		else
			if [[ -e ${_vendor_lib_dir} ]]
			then
				if [[ -e ${_vendor_lib_dir}/${_file} ]]
				then
					foundc=$((foundc + 1))
				else
					printf '%s not found in %s, neither in %s\n' "${_file}" "${_lib_dir}" "${_vendor_lib_dir}" | tee -a ${_missing}
					nfoundc=$((nfoundc + 1))
				fi
			else
				printf '%s not found in %s\n' "${_file}" "${_lib_dir}" | tee -a ${_missing}
				nfoundc=$((nfoundc + 1))
			fi
		fi
	done < "${_lib_list}"

	if [ "${nfoundc}" == "1" ]
	then
		a="$(cat ${_missing} | head -2 | tail -n 1 | cut -d " " -f 1)"
	fi

	printf '\nRace results:\n  %s/%s (%s) missing\n\n' "${nfoundc}" "${foundc}" "${a}"
	printf 'The list with missing files saved on:\n  %s\n\n' "${_missing}"

	# Exit at end
	break
done

printf 'Thanks for use this script - Written by Caio Oliveira aka Caio99BR\n'
