#!/bin/bash
# Slim script to tracer blobs for Android ROMs by Caio99BR <caiooliveirafarias0@gmail.com>

# Empty variables
foundc=0
nfoundc=0
_lib_dir="lib/"
_vendor_lib_dir="vendor/lib/"
_lib_list="/tmp/t-sh.txt"
_missing="$(pwd)/t-sh-missing-files.txt"

printf '  WARNING\n'
printf "Make sure you are inside of '/system' dir\n"
printf "If not, the script will be useless\n"
printf '  WARNING\n'
read -p "Press any key to continue..." -s ask
printf '\n'

# Make loop for usage of 'break' to recursive exit
while true
do
	if [ ! "${BASH_VERSION}" ]
	then
		echo "  |"
		echo "  | Please do not use 'sh' to run this script"
		echo "  | Just use 'source build.sh'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'objdump' is installed
	if [ ! "$(which objdump)" ]
	then
		echo "  |"
		echo "  | You will need to install 'objdump'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'find' is installed
	if [ ! "$(which find)" ]
	then
		echo "  |"
		echo "  | You will need to install 'find'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'grep' is installed
	if [ ! "$(which grep)" ]
	then
		echo "  |"
		echo "  | You will need to install 'grep'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'sort' is installed
	if [ ! "$(which sort)" ]
	then
		echo "  |"
		echo "  | You will need to install 'sort'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'uniq' is installed
	if [ ! "$(which uniq)" ]
	then
		echo "  |"
		echo "  | You will need to install 'uniq'"
		echo "  | Exiting from script!"
		break
	fi

	# Check if 'sed' is installed
	if [ ! "$(which sed)" ]
	then
		echo "  |"
		echo "  | You will need to install 'sed'"
		echo "  | Exiting from script!"
		break
	fi

	echo "# Auto generated by Android Blob Utility Script" > ${_missing}

	objdump -x $(find .) | grep NEEDED | sort | uniq | sed 's/  NEEDED               //' > ${_lib_list}

	while IFS= read -r _file
	do
		if [[ -e ${_lib_dir}/${_file} ]]
		then
			foundc=$((foundc + 1))
		else
			if [[ -e ${_vendor_lib_dir} ]]
			then
				if [[ -e ${_vendor_lib_dir}/${_file} ]]
				then
					foundc=$((foundc + 1))
				else
					printf '%s not found in %s, neither in %s\n' "${_file}" "${_lib_dir}" "${_vendor_lib_dir}" | tee -a ${_missing}
					nfoundc=$((nfoundc + 1))
				fi
			else
				printf '%s not found in %s\n' "${_file}" "${_lib_dir}" | tee -a ${_missing}
				nfoundc=$((nfoundc + 1))
			fi
		fi
	done < "${_lib_list}"

	printf 'Race results:\n'
	printf '    Found: %s\n' "${foundc}"
	printf '  Missing: %s\n' "${nfoundc}"
	printf 'Missing files list saved on:\n'
	printf '           %s\n' "${_missing}"

	# Exit at end
	break
done

printf 'Thanks for use this script :)\n'
printf 'Made by Caio99BR\n'
