#!/bin/bash
# Slim script to tracer blobs for Android ROMs by Caio99BR <caiooliveirafarias0@gmail.com>

# Empty variables
ABLOBS_NUMBER_OF_FILES=0
ABLOBS_NUMBER_OF_FILES_FOUND=0

ABLOBS_CURRENT_DIR="$(pwd)"
ABLOBS_LIB_DIR="${ABLOBS_CURRENT_DIR}/lib/"
ABLOBS_VENDOR_LIB_DIR="${ABLOBS_CURRENT_DIR}/vendor/lib/"

ABLOBS_LIST="/tmp/ablobs-missing_files.txt"
ABLOBS_MISSING_LIST="${ABLOBS_CURRENT_DIR}/ablobs-missing_files.txt"

rm -rf ${ABLOBS_LIST} ${ABLOBS_MISSING_LIST}

printf '\n  WARNING\n'
printf "Make sure you are inside of '/system' dir\n"
printf "If not, the script will be useless\n"
printf '  WARNING\n\n'
read -p "Press any key to continue..." -s ask
printf '\n\n'

# Make loop for usage of 'break' to recursive exit
while true
do
	if [ ! "${BASH_VERSION}" ]
	then
		echo "  |"
		echo "  | Please do not use 'sh' to run this script"
		echo "  | Just use 'source build.sh'"
		echo "  | Exiting from script!"
		break
	fi

	# Check for tools installed
	for TARGET in "objdump" "find" "grep" "sort" "uniq" "sed"
	do
		which ${TARGET} 1> /dev/null || { echo "  | ERROR: Install $TARGET before continuing."; break; }
	done

	echo "# Auto generated by Android Blob Utility Script" > ${ABLOBS_MISSING_LIST}

	printf 'objdump working, see to other side \n'
	objdump -x $(find . | grep -v /app | grep -v /priv-app | grep -v /usr | grep -v /tts | grep -v /etc | grep -v /media | grep -v /framework | grep -v /fonts | grep -v /addon.d | grep -v .txt | grep -v .bc | grep -v build.prop | grep -v keymaster | grep -v ablobs) | grep NEEDED | grep -v libEGL_adreno.so | sort | uniq | cut -d " " -f 18 >> ${ABLOBS_LIST}

	while IFS= read -r ABLOBS_FILE
	do
		if [[ -e ${ABLOBS_LIB_DIR}/${ABLOBS_FILE} ]]
		then
			ABLOBS_NUMBER_OF_FILES=$((ABLOBS_NUMBER_OF_FILES + 1))
		else
			if [[ -e ${ABLOBS_VENDOR_LIB_DIR} ]]
			then
				if [[ -e ${ABLOBS_VENDOR_LIB_DIR}/${ABLOBS_FILE} ]]
				then
					ABLOBS_NUMBER_OF_FILES=$((ABLOBS_NUMBER_OF_FILES + 1))
				else
					printf '%s not found in %s, neither in %s\n' "${ABLOBS_FILE}" "${ABLOBS_LIB_DIR}" "${ABLOBS_VENDOR_LIB_DIR}" | tee -a ${ABLOBS_MISSING_LIST}
					ABLOBS_NUMBER_OF_FILES_FOUND=$((ABLOBS_NUMBER_OF_FILES_FOUND + 1))
				fi
			else
				printf '%s not found in %s\n' "${ABLOBS_FILE}" "${ABLOBS_LIB_DIR}" | tee -a ${ABLOBS_MISSING_LIST}
				ABLOBS_NUMBER_OF_FILES_FOUND=$((ABLOBS_NUMBER_OF_FILES_FOUND + 1))
			fi
		fi
	done < "${ABLOBS_LIST}"

	if [ ${ABLOBS_NUMBER_OF_FILES_FOUND} == "0" ]
	then
		rm -rf ${ABLOBS_MISSING_LIST}
	fi

	printf '\nRace results:\n  %s/%s Missing\n\n' "${ABLOBS_NUMBER_OF_FILES_FOUND}" "${ABLOBS_NUMBER_OF_FILES}"
	printf 'The list with missing files saved on:\n  %s\n\n' "${ABLOBS_MISSING_LIST}"

	# Exit at end
	break
done

unset ABLOBS_NUMBER_OF_FILES_FOUND ABLOBS_NUMBER_OF_FILES ABLOBS_VENDOR_LIB_DIR ABLOBS_LIB_DIR ABLOBS_LIST ABLOBS_MISSING_LIST

printf 'Thanks for use this script - Written by Caio Oliveira aka Caio99BR\n'
